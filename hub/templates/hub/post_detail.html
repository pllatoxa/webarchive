{% extends 'archive/base.html' %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<article class="detail">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:1rem;">
        <div>
            <h1>{{ post.title }}</h1>
            <div class="meta">
                {{ post.author.profile.nickname|default:post.author.username }}
                • {{ post.created_at|date:"d.m.Y H:i" }}
            </div>
        </div>

        {% if request.user.is_authenticated and request.user == post.author %}
            <form action="{% url 'post_delete' post.pk %}"
                  method="post"
                  onsubmit="return confirm('Точно удалить этот пост? Это действие нельзя отменить.');">
                {% csrf_token %}
                <button type="submit" class="button danger small">
                    Удалить пост
                </button>
            </form>
        {% endif %}
    </div>

    <section class="full-text">
        {{ post.body|linebreaks }}
    </section>
</article>

<section class="detail">
    <h2>Комментарии ({{ comments|length }})</h2>

    <div class="full-text" style="margin-bottom:1rem;">
        {% for comment in comments %}
            <div class="card" style="padding:0.8rem 1rem; margin-bottom:0.6rem;">
                <div style="display:flex; align-items:center; gap:0.6rem; margin-bottom:0.3rem;">
                    {% with p=comment.author.profile %}
                        {% if p.avatar %}
                            <img src="{{ p.avatar.url }}" alt="{{ comment.author.username }}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                        {% elif p.avatar_url %}
                            <img src="{{ p.avatar_url }}" alt="{{ comment.author.username }}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                        {% else %}
                            <div style="width:40px;height:40px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-weight:700;">
                                {{ comment.author.username|first|upper }}
                            </div>
                        {% endif %}
                    {% endwith %}
                    <div>
                        <div class="meta">
                            {{ comment.author.profile.nickname|default:comment.author.username }}
                            • {{ comment.created_at|date:"d.m.Y H:i" }}
                        </div>
                        <p style="margin:0;">{{ comment.body|linebreaks }}</p>
                        {% if comment.replies.all %}
                            <div style="margin-top:0.4rem; padding-left:1.5rem; border-left:1px solid var(--border); display:flex; flex-direction:column; gap:0.3rem;">
                                {% for reply in comment.replies.all %}
                                    <div style="display:flex; align-items:center; gap:0.4rem;">
                                        {% with p=reply.author.profile %}
                                            {% if p.avatar %}
                                                <img src="{{ p.avatar.url }}" alt="{{ reply.author.username }}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;">
                                            {% elif p.avatar_url %}
                                                <img src="{{ p.avatar_url }}" alt="{{ reply.author.username }}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;">
                                            {% else %}
                                                <div style="width:30px;height:30px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-weight:700;">
                                                    {{ reply.author.username|first|upper }}
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                        <div>
                                            <div class="meta">
                                                {{ reply.author.profile.nickname|default:reply.author.username }}
                                                • {{ reply.created_at|date:"d.m.Y H:i" }}
                                            </div>
                                            <div>{{ reply.body|linebreaks }}</div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {% if request.user.is_authenticated %}
                            <form method="post" style="margin-top:0.4rem;">
                                {% csrf_token %}
                                {{ form.non_field_errors }}
                                <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                <div class="form-row">
                                    {{ form.body }}
                                </div>
                                <button type="submit" class="button ghost small">Ответить</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <p class="meta">Пока нет комментариев.</p>
        {% endfor %}
    </div>

    {% if request.user.is_authenticated %}
        <div class="panel">
            <h3>Добавить комментарий</h3>
            <form method="post">
                {% csrf_token %}
                {{ form.non_field_errors }}
                <div class="form-row">
                    {{ form.body }}
                </div>
                <button type="submit" class="button primary">Отправить</button>
            </form>
        </div>
    {% else %}
        <p class="meta">Войдите, чтобы оставлять комментарии.</p>
    {% endif %}
</section>
{% endblock %}
