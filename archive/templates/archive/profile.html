{% extends "archive/base.html" %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<section class="detail auth-card">
    <h1>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h1>
    <p class="lead">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤–∞—Ç–∞—Ä, –Ω–∏–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ.</p>

    <form method="post" enctype="multipart/form-data" class="auth-form">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div class="form-row">
            <label>–ê–≤–∞—Ç–∞—Ä</label>

            <!-- –ü—Ä–µ–≤—å—é —Ç–µ–∫—É—â–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ -->
            <div class="avatar-preview-wrap">
                {% with avatar=form.instance.avatar avatar_url=form.instance.avatar_url %}
                    {% if avatar %}
                        <img src="{{ avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" id="avatar-preview" class="avatar-preview">
                    {% elif avatar_url %}
                        <img src="{{ avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä" id="avatar-preview" class="avatar-preview">
                    {% else %}
                        <div class="avatar-preview avatar-preview-placeholder" id="avatar-preview-placeholder">
                            {{ request.user.username|first|upper }}
                        </div>
                    {% endif %}
                {% endwith %}
            </div>

            <!-- –î—Ä–æ–ø–∑–æ–Ω–∞ -->
            <div class="upload-dropzone avatar-dropzone" id="avatar-dropzone">
                <div class="dropzone-icon">üìÅ</div>
                <div class="dropzone-text">
                    <strong>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—é–¥–∞</strong>
                    <span class="meta">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                </div>
            </div>

            <!-- –°–∫—Ä—ã—Ç—ã–π –Ω–∞—Å—Ç–æ—è—â–∏–π input –ë–ï–ó —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö ¬´–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç¬ª -->
            <input type="file"
                   name="{{ form.avatar.name }}"
                   id="{{ form.avatar.id_for_label }}"
                   accept="image/*">

            {{ form.avatar.errors }}
        </div>

        <div class="form-row">
            <label for="{{ form.nickname.id_for_label }}">–ù–∏–∫–Ω–µ–π–º</label>
            {{ form.nickname }}
        </div>

        <div class="form-row">
            <label for="{{ form.bio.id_for_label }}">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            {{ form.bio }}
        </div>

        <div class="actions">
            <button type="submit" class="button primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </form>
</section>

<script>
(function() {
    const dropzone = document.getElementById('avatar-dropzone');
    const input = document.getElementById('{{ form.avatar.id_for_label }}');
    const imgPreview = document.getElementById('avatar-preview');
    const placeholder = document.getElementById('avatar-preview-placeholder');

    if (!dropzone || !input) return;

    // –ü—Ä—è—á–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π input
    input.style.position = 'absolute';
    input.style.left = '-9999px';

    // –ö–ª–∏–∫ –ø–æ –∑–æ–Ω–µ = –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
    dropzone.addEventListener('click', function () {
        input.click();
    });

    // drag-over –ø–æ–¥—Å–≤–µ—Ç–∫–∞
    dropzone.addEventListener('dragover', function (e) {
        e.preventDefault();
        dropzone.classList.add('drag-over');
    });

    dropzone.addEventListener('dragleave', function (e) {
        e.preventDefault();
        dropzone.classList.remove('drag-over');
    });

    // drop —Ñ–∞–π–ª–∞
    dropzone.addEventListener('drop', function (e) {
        e.preventDefault();
        dropzone.classList.remove('drag-over');
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
            input.files = e.dataTransfer.files;
            handlePreview(input.files[0]);
        }
    });

    // –≤—ã–±–æ—Ä —á–µ—Ä–µ–∑ –¥–∏–∞–ª–æ–≥
    input.addEventListener('change', function () {
        if (input.files && input.files[0]) {
            handlePreview(input.files[0]);
        }
    });

    function handlePreview(file) {
        if (!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.onload = function (e) {
            if (imgPreview) {
                imgPreview.src = e.target.result;
                imgPreview.style.display = 'block';
            }
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        };
        reader.readAsDataURL(file);
    }
})();
</script>
{% endblock %}
